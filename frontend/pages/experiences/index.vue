<script setup lang="ts">
import { h } from 'vue';
import { useAuthStore } from '~/stores/auth-store';
import { useExperienceStore } from '~/stores/experience-store';
import { ActionItem, Experience } from '~/types';
import { useRouterQuery } from '~/composables/useRouterQuery';
import ExperienceCard from '~/components/cards/ExperienceCard.vue';

const query = useRouterQuery();
const authStore = useAuthStore();
const experienceStore = useExperienceStore();

const experiences = ref<Experience[]>([]);
const loading = ref<boolean>(false);

const filter = reactive({
	projects: false,
	education: false,
	work: false
});

const options = computed<ActionItem[]>(() => {
	let base: ActionItem[] = [
		{
			label: 'Education',
			color: filter.education ? 'education' : 'secondary',
			action: () => { filter.education = !filter.education; }
		},
		{
			label: 'Work',
			color: filter.work ? 'job' : 'secondary',
			action: () => { filter.work = !filter.work; }
		},
		{
			label: 'Projects',
			color: filter.projects ? 'project' : 'secondary',
			action: () => { filter.projects = !filter.projects; }
		}
	];

	if (authStore.isLoggedIn) {
		base = [
			...base,
			{
				label: 'Create xP',
				color: 'primary',
				icon: 'mdi-plus',
				to: '/experiences/create'
			}
		];
	}

	return base;
});

const getExperiences = computed<Experience[]>(() => {
	return experiences.value.filter((experience) => {
		if (!filter.education && !filter.projects && !filter.work) {
			return true;
		} else if (experience.type === 'education') {
			return filter.education;
		} else if (experience.type === 'job') {
			return filter.work;
		} else if (experience.type === 'project') {
			return filter.projects;
		} else {
			return true;
		}
	});
});

const components = computed(() => {
	return getExperiences.value.map((experience) => {
		// return a NoteCard component with the note prop set to the note
		return h(ExperienceCard, { experience, adminMode: authStore.isLoggedIn });
	});
});

// watch filters and update the url query
watch(
	() => filter.education,
	async (value) => {
		if (value) {
			await query.add('education', 'true');
		} else {
			await query.remove('education');
		}
	}
);

watch(
	() => filter.work,
	async (value) => {
		if (value) {
			await query.add('work', 'true');
		} else {
			await query.remove('work');
		}
	}
);

watch(
	() => filter.projects,
	async (value) => {
		if (value) {
			await query.add('projects', 'true');
		} else {
			await query.remove('projects');
		}
	}
);

onMounted(async () => {
	loading.value = true;
	experiences.value = await experienceStore.indexExperiences();
	loading.value = false;

	// set filters from url query
	if (query.has('education')) {
		filter.education = query.get('education') === 'true';
	}

	if (query.has('work')) {
		filter.work = query.get('work') === 'true';
	}

	if (query.has('projects')) {
		filter.projects = query.get('projects') === 'true';
	}
});

const pageTitle = 'Experiences - oliverrr';
const pageDescription = 'A collection of experiences';
useSeoMeta({
	title: pageTitle,
	description: pageDescription,
	ogTitle: pageTitle,
	ogDescription: pageDescription,
	ogSiteName: 'oliverrr\'s personal website'
});

</script>

<template>
  <base-page title="Experiences">
    <v-row justify="center">
      <v-col lg="7">
        <base-list
          label="experiences"
          :options="options"
          :loading="loading"
          :components="components" />
      </v-col>
    </v-row>
  </base-page>
</template>
